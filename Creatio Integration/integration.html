<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>
    Tailwind CSS Table with Server-Side Pagination and API Data (OpenText Integration)
  </title>
  <!-- Include Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Include jQuery via CDN -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-gray-100">
  <div class="container mx-auto px-4 py-8">
    <!-- Upload New Document Button -->
    <div class="flex justify-end mb-4">
      <button
        id="upload-button"
        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow"
      >
        Upload New Document
      </button>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white shadow-md rounded-lg overflow-hidden">
        <thead
          class="bg-gradient-to-r from-blue-500 to-purple-600 text-white"
        >
          <tr>
            <th class="px-6 py-3 text-left text-sm font-semibold">Name</th>
            <th class="px-6 py-3 text-left text-sm font-semibold">
              Created On
            </th>
            <th class="px-6 py-3 text-left text-sm font-semibold">
              Size (MB)
            </th>
            <th class="px-6 py-3"></th>
            <!-- Empty header for the Open button -->
          </tr>
        </thead>
        <tbody id="table-body" class="divide-y divide-gray-200">
          <!-- Data rows will be injected here -->
        </tbody>
      </table>
    </div>

    <!-- Pagination Controls -->
    <div class="flex justify-between items-center mt-4">
      <button
        id="prev-page"
        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow disabled:opacity-50 disabled:cursor-not-allowed"
        disabled
      >
        Previous
      </button>
      <div id="page-info" class="text-gray-700 font-semibold">
        Page <span id="current-page">1</span> of <span id="total-pages">1</span>
      </div>
      <button
        id="next-page"
        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow disabled:opacity-50 disabled:cursor-not-allowed"
        disabled
      >
        Next
      </button>
    </div>
  </div>

  <!-- Upload Modal -->
  <div
    id="upload-modal"
    class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden"
  >
    <div class="bg-white rounded-lg p-6 w-96">
      <h2 class="text-xl font-semibold mb-4">Upload Document</h2>
      <form id="upload-form">
        <input
          type="file"
          id="file-input"
          name="file"
          required
          class="mb-4"
        />
        <div class="flex justify-end">
          <button
            type="button"
            id="cancel-upload"
            class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg mr-2"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg"
          >
            Upload
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- JavaScript to Fetch Data and Handle Pagination -->
  <script>
    $(document).ready(function () {
      const tableBody = $("#table-body");
      const prevPageBtn = $("#prev-page");
      const nextPageBtn = $("#next-page");
      const currentPageSpan = $("#current-page");
      const totalPagesSpan = $("#total-pages");
      const uploadButton = $("#upload-button");
      const uploadModal = $("#upload-modal");
      const cancelUploadButton = $("#cancel-upload");
      const uploadForm = $("#upload-form");
      const fileInput = $("#file-input");

      // OpenText Content Server API Base URL
      const baseURI = "http://192.168.17.128/otcs/cs.exe/api"; // Remove version from baseURI

      // Authentication Credentials
      const username = "admin"; // Replace with your username
      const password = "livelink"; // Replace with your password

      // Variables for authentication and folder ID
      let authToken = null;
      const objId = getParameterByName("objId"); // Default folder ID if not provided

      const pageSize = 5;
      let currentPage = 1;
      let totalPages = 1;

      // Authenticate with OpenText Content Server
      const authenticate = function () {
        // Prepare FormData
        const formData = new FormData();
        formData.append("username", username);
        formData.append("password", password);

        return $.ajax({
          url: `${baseURI}/v1/auth`, // Specify API version in endpoint
          type: "POST",
          dataType: "json",
          data: formData,
          processData: false, // Prevent jQuery from processing the data
          contentType: false, // Let the browser set the Content-Type, including the boundary
          success: function (response) {
            authToken = response.ticket; // Adjust based on actual response
          },
          error: function (xhr, status, error) {
            console.error("Authentication failed:", error);
            alert("Failed to authenticate with the server.");
          },
        });
      };

      // Fetch items in the folder with pagination using /v2/nodes/{id}/nodes
      const fetchData = function () {
        const apiURL = `${baseURI}/v2/nodes/${objId}/nodes`;

        // Prepare query parameters
        const params = {
          limit: pageSize,
          page: currentPage,
          sort: "desc_create_date", // Adjust sort as needed
          // Include other parameters as required
        };

        // Serialize parameters
        const queryString = $.param(params);

        $.ajax({
          url: `${apiURL}?${queryString}`,
          type: "GET",
          dataType: "json",
          headers: {
            OTCSTicket: `${authToken}`,
          },
          success: function (response) {
            const data = response.results;
            const totalCount = response.collection.paging.total_count;
            totalPages = Math.ceil(totalCount / pageSize);
            totalPagesSpan.text(totalPages);
            displayData(data);
            updatePaginationButtons();
          },
          error: function (xhr, status, error) {
            console.error("Error fetching data:", error);
            alert("Failed to fetch data from the server.");
          },
        });
      };

      const displayData = function (data) {
        tableBody.empty();

        data.forEach(function (item) {
          const properties = item.data.properties;
          const createdOn = new Date(
            properties.create_date
          ).toLocaleString();
          const sizeMB = (properties.size / (1024 * 1024)).toFixed(2);

          const row = $(`
          <tr class="hover:bg-gray-100">
            <td class="px-6 py-4">${properties.name}</td>
            <td class="px-6 py-4">${createdOn}</td>
            <td class="px-6 py-4">${sizeMB}</td>
            <td class="px-6 py-4 text-right">
              <button class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg shadow open-button" data-id="${
                properties.id
              }">
                Open
              </button>
            </td>
          </tr>
        `);

          tableBody.append(row);
        });

        currentPageSpan.text(currentPage);
      };

      const updatePaginationButtons = function () {
        prevPageBtn.prop("disabled", currentPage === 1);
        nextPageBtn.prop("disabled", currentPage >= totalPages);
      };

      prevPageBtn.on("click", function () {
        if (currentPage > 1) {
          currentPage--;
          fetchData();
        }
      });

      nextPageBtn.on("click", function () {
        if (currentPage < totalPages) {
          currentPage++;
          fetchData();
        }
      });
      tableBody.on("click", ".open-button", function () {
      const itemId = $(this).data("id");
      const fileURL = `${baseURI}/v1/nodes/${itemId}/content?action=open`;

      // Fetch the file data with headers
      $.ajax({
        url: fileURL,
        type: "GET",
        xhrFields: {
          responseType: "blob",
        },
        headers: {
          OTCSTicket: `${authToken}`,
        },
        success: function (data, status, xhr) {
          const blob = new Blob([data], {
            type: xhr.getResponseHeader("Content-Type"),
          });
          const blobURL = URL.createObjectURL(blob);
          
          // Open in new tab for browser to decide how to handle it (view or download)
          window.open(blobURL, "_blank");
          
          // Clean up after a delay
          setTimeout(() => {
            URL.revokeObjectURL(blobURL);
          }, 10000);
        },
        error: function (xhr, status, error) {
          console.error("Error fetching file:", error);
          alert("Failed to open the file.");
        },
      });
    });
      // Handle Upload Button Click
      uploadButton.on("click", function () {
        // Show the upload modal
        uploadModal.removeClass("hidden");
      });

      // Handle Cancel Upload Button Click
      cancelUploadButton.on("click", function () {
        // Hide the upload modal
        uploadModal.addClass("hidden");
        // Reset the form
        uploadForm[0].reset();
      });

      // Handle Upload Form Submission
      uploadForm.on("submit", function (e) {
        e.preventDefault();

        const file = fileInput[0].files[0];
        if (!file) {
          alert("Please select a file to upload.");
          return;
        }

        const formData = new FormData();
        formData.append("type", 144);
        formData.append("parent_id", objId);
        formData.append("file", file);
        formData.append("name", file.name);

        // Send the file via AJAX
        $.ajax({
          url: `${baseURI}/v2/nodes`, // Adjust API version and endpoint as needed
          type: "POST",
          data: formData,
          processData: false,
          contentType: false,
          headers: {
            OTCSTicket: `${authToken}`,
          },
          success: function (response) {
            // Hide the upload modal
            uploadModal.addClass("hidden");
            // Reset the form
            uploadForm[0].reset();
            // Refresh the table data
            fetchData();
          },
          error: function (xhr, status, error) {
            console.error("Error uploading file:", error);
            alert("Failed to upload the file.");
          },
        });
      });

      // Utility function to get URL parameters
      function getParameterByName(name) {
        const url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        const regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
          results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return "";
        return decodeURIComponent(results[2].replace(/\+/g, " "));
      }

      // Initialize the application
      const init = function () {
        // Authenticate first
        authenticate().then(function () {
          // Fetch initial data
          fetchData();
        });
      };

      // Start the app
      init();
    });
  </script>
</body>
</html>
